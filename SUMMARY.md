# 📊 项目分析与部署方案总结

---

## 🔍 原理分析

### 项目功能
UESTC-Energyfy 是一个**电子科技大学宿舍电费余额自动监控系统**。

### 核心工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                        主循环 (while True)                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. 读取配置文件                                              │
│     ├── 学号、密码                                            │
│     ├── 监控的宿舍号                                          │
│     ├── 告警阈值                                              │
│     └── 通知配置 (邮件/Server酱)                             │
│                                                               │
│  2. 模拟登录 UESTC 统一认证平台                              │
│     ├── 获取登录页面，解析加密 JS                            │
│     ├── 使用 execjs 执行 JS 加密密码                         │
│     ├── 提交登录请求                                          │
│     └── 跟随重定向链，获取会话 Cookie                        │
│                                                               │
│  3. 查询宿舍电费余额                                          │
│     ├── 使用登录后的 Cookie                                  │
│     ├── 调用电费查询 API                                     │
│     └── 解析 JSON 响应，提取余额信息                         │
│                                                               │
│  4. 判断是否需要告警                                          │
│     ├── 余额 < 阈值 → 触发告警                               │
│     └── 余额 >= 阈值 → 仅记录                                │
│                                                               │
│  5. 发送通知 (并发执行)                                       │
│     ├── 邮件通知 (SMTP)                                      │
│     └── Server酱推送 (HTTP API)                             │
│                                                               │
│  6. 等待下一次检查                                            │
│     └── sleep(check_interval)                               │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 关键技术

| 技术 | 用途 |
|------|------|
| **requests** | HTTP 请求，模拟浏览器 |
| **BeautifulSoup** | 解析 HTML 页面 |
| **execjs** | 执行 JavaScript 加密代码 |
| **smtplib** | 发送邮件通知 |
| **concurrent.futures** | 并发发送通知 |

---

## 🎯 适用性评估

### ❌ **不适合笔记本电脑的原因**

| 问题 | 说明 |
|------|------|
| **需要长期运行** | 程序是一个无限循环 (`while True`)，需要 24/7 不间断运行 |
| **关机即停止** | 笔记本关机后监控完全停止，无法及时发现余额不足 |
| **资源占用** | 虽然不大（~50MB 内存），但长期占用系统资源 |
| **稳定性差** | 网络波动、休眠、重启都会中断服务 |
| **不经济** | 长期开机耗电，不如使用云服务 |

### ✅ **适合云端运行的原因**

#### 方案对比

| 特性 | GitHub Actions | 云服务器 | 本地电脑 |
|------|----------------|----------|----------|
| **成本** | 🟢 免费 | 🟡 付费 | 🟢 免费 |
| **稳定性** | 🟢 非常高 | 🟢 非常高 | 🔴 低 |
| **维护成本** | 🟢 零维护 | 🟡 需要配置 | 🔴 高 |
| **响应速度** | 🟡 5分钟间隔 | 🟢 任意间隔 | 🟢 任意间隔 |
| **易用性** | 🟢 非常简单 | 🟡 需要技术 | 🟢 简单 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ |

---

## 🚀 推荐方案：GitHub Actions

### 为什么选择 GitHub Actions？

1. **完全免费**
   - 公开仓库：无限制
   - 私有仓库：每月 2000 分钟免费额度
   - 本项目每次运行 1-2 分钟，每月约 1440 次，完全够用

2. **零维护成本**
   - 无需配置服务器
   - 无需安装环境
   - 无需担心宕机

3. **高可靠性**
   - GitHub 基础设施，可靠性极高
   - 自动重试机制
   - 完善的日志系统

4. **配置简单**
   - 5 分钟完成部署
   - 图形界面配置
   - 所见即所得

### 工作原理

```
GitHub Actions 定时触发 (cron: */30 * * * *)
                ↓
        启动 Ubuntu 虚拟机
                ↓
        克隆代码 + 安装依赖
                ↓
    从 GitHub Secrets 读取配置
                ↓
        生成 config.json
                ↓
    运行 Energyfy.py (单次模式)
                ↓
        查询余额 + 发送通知
                ↓
        记录日志 + 结束运行
                ↓
    等待下一个 30 分钟周期
```

### 核心优化

| 原始设计 | Actions 优化 | 原因 |
|---------|-------------|------|
| 本地配置文件 | 从环境变量生成 | GitHub Secrets 更安全 |
| 长期运行模式 | 单次运行模式 | 每次触发独立执行 |
| 手动配置 | 脚本自动生成 | 减少出错，提高效率 |
| 本地日志 | 云端日志 | 随时查看，不占本地空间 |

---

## 📦 交付内容

### 新增文件

```
.github/workflows/energy-monitor.yml   # GitHub Actions 工作流定义
scripts/generate_config.py            # 配置生成脚本
scripts/test_config.py                 # 配置验证工具
requirements.txt                       # Python 依赖列表
config.example.json                    # 配置文件示例
QUICKSTART.md                          # ⚡️ 5分钟快速开始
DEPLOYMENT.md                          # 📖 完整部署指南 (GitHub Actions)
CLOUDSERVER.md                         # ☁️ 云服务器部署指南
README_NEW.md                          # 🆕 新版 README
SUMMARY.md                             # 📊 本文件 (分析总结)
```

### 功能特性

- ✅ **GitHub Actions 自动化**：每 30 分钟自动检查
- ✅ **配置生成脚本**：从环境变量生成配置，避免手动编辑
- ✅ **配置验证工具**：本地测试配置，减少部署错误
- ✅ **完整文档体系**：从新手到专家，覆盖所有场景
- ✅ **云服务器支持**：提供 systemd 服务、Docker 等多种方案
- ✅ **向后兼容**：保留原有功能，可以继续本地运行

---

## 🎓 使用指南

### 场景 1：我是新手，想快速部署

👉 **推荐方案**：GitHub Actions  
📖 **参考文档**：[QUICKSTART.md](QUICKSTART.md)  
⏱ **预计时间**：5 分钟

**步骤：**
1. Fork 仓库
2. 添加 8 个 GitHub Secrets
3. 启用 Actions
4. 完成！

---

### 场景 2：我有云服务器

👉 **推荐方案**：云服务器 systemd 服务  
📖 **参考文档**：[CLOUDSERVER.md](CLOUDSERVER.md)  
⏱ **预计时间**：15 分钟

**步骤：**
1. 运行一键安装脚本
2. 编辑配置文件
3. 创建 systemd 服务
4. 启动并设置开机自启

---

### 场景 3：我想本地测试

👉 **推荐方案**：本地运行  
📖 **参考文档**：[README_ORIGINAL.md](README_ORIGINAL.md)  
⏱ **预计时间**：10 分钟

**步骤：**
1. 安装 Python 依赖
2. 创建配置文件
3. 运行验证脚本
4. 启动程序

---

## 🛡️ 安全建议

### 配置安全

| ✅ 推荐做法 | ❌ 不推荐 |
|------------|----------|
| 使用 GitHub Secrets | 配置文件提交到公开仓库 |
| 仓库设为私有 | 使用公开仓库存储敏感信息 |
| 使用邮箱授权码 | 使用邮箱真实密码 |
| 定期更换密码 | 长期不更换 |
| 限制配置文件权限 (`chmod 600`) | 所有人可读 |

### 运行安全

- ✅ 使用独立的邮箱账号
- ✅ 为 SMTP 创建专用授权码
- ✅ 定期检查 Actions 运行日志
- ✅ 监控异常登录尝试
- ✅ 不要分享你的配置和 Secrets

---

## 📈 性能优化

### 检查间隔建议

| 场景 | 间隔 | 说明 |
|------|------|------|
| **高频监控** | 10-15 分钟 | 适合余额紧张时期 |
| **常规监控** | 30 分钟 | **推荐**，平衡及时性和资源 |
| **低频监控** | 1-2 小时 | 适合余额充足时期 |
| **每日检查** | 每天固定时间 | 适合不紧急情况 |

⚠️ **注意**：间隔过短可能导致账号被冻结，建议不低于 10 分钟。

### GitHub Actions 限制

- **公开仓库**：无限制
- **私有仓库**：每月 2000 分钟
- **每次运行**：约 1-2 分钟
- **每月运行次数**（30分钟间隔）：约 1440 次
- **每月消耗**：约 1440-2880 分钟

💡 **结论**：如果是私有仓库且每 30 分钟运行一次，可能会超出免费额度。建议：
- 使用公开仓库（推荐）
- 延长检查间隔（如 1 小时）
- 设置为仅在工作日运行

---

## 🔧 故障排除

### 常见问题速查表

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 登录失败 401 | 密码错误或需要验证 | 到官网手动登录一次 |
| SMTP 认证失败 | 未使用授权码 | 使用邮箱授权码，不是密码 |
| execjs 错误 | 缺少 JS 运行时 | 安装 Node.js |
| Actions 未执行 | 未启用 workflow | 在 Actions 页面启用 |
| 配置验证失败 | 格式错误 | 使用 test_config.py 验证 |

---

## 📊 成本对比

### 三年总成本估算

| 方案 | 第一年 | 第二年 | 第三年 | 三年总计 |
|------|--------|--------|--------|----------|
| **GitHub Actions** | ¥0 | ¥0 | ¥0 | **¥0** |
| **云服务器** (最低配) | ¥300 | ¥300 | ¥300 | **¥900** |
| **本地电脑** (24h开机) | ¥180 | ¥180 | ¥180 | **¥540** |

*注：云服务器按阿里云轻量应用服务器最低配计算，本地电脑按 100W 功耗、每度电 ¥0.6 计算*

💡 **结论**：GitHub Actions 是最经济的方案。

---

## 🎉 总结

### 核心结论

1. **原项目不适合笔记本电脑**
   - 需要长期运行
   - 关机即停止
   - 稳定性差

2. **GitHub Actions 是最佳方案**
   - 完全免费
   - 零维护
   - 高可靠
   - 易配置

3. **已提供完整解决方案**
   - 一键部署工作流
   - 自动配置生成
   - 配置验证工具
   - 详尽的文档

### 快速开始

```bash
# 方式 1: GitHub Actions (推荐)
# 1. Fork 本仓库
# 2. 配置 8 个 Secrets
# 3. 启用 Actions
# 完成！

# 方式 2: 云服务器
cd ~/UESTC-Energyfy
./install_energyfy.sh
nano config.json
sudo systemctl enable energyfy
sudo systemctl start energyfy

# 方式 3: 本地测试
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
cp config.example.json config.json
nano config.json
python3 scripts/test_config.py
python3 Energyfy.py -c config.json
```

### 下一步行动

1. ✅ 阅读 [快速开始指南](QUICKSTART.md)
2. ✅ 准备必要的配置信息
3. ✅ Fork 仓库并配置 Secrets
4. ✅ 启用 Actions 并测试
5. ✅ 享受自动化监控服务！

---

## 📞 技术支持

遇到问题？

1. 📖 查看对应文档
2. 🔍 搜索 Issues
3. 🐛 提交新 Issue
4. 💬 参与讨论

---

**祝你使用愉快！** 🎉

---

*文档版本：v1.0*  
*最后更新：2024-01-XX*
