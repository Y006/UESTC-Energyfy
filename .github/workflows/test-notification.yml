name: Test Notification

on:
  # åªæ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_message:
        description: 'æµ‹è¯•æ¶ˆæ¯å†…å®¹'
        required: false
        default: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¨é€æ¶ˆæ¯'
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“± æµ‹è¯• Serveré…± æ¨é€
      env:
        SERVER_CHAN_UID: ${{ secrets.SERVER_CHAN_UID }}
        SERVER_CHAN_SENDKEY: ${{ secrets.SERVER_CHAN_SENDKEY }}
        TEST_MESSAGE: ${{ github.event.inputs.test_message }}
      run: |
        python - <<EOF
        import os
        import requests
        import json
        
        uid = os.environ.get('SERVER_CHAN_UID')
        sendkey = os.environ.get('SERVER_CHAN_SENDKEY')
        message = os.environ.get('TEST_MESSAGE', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¨é€æ¶ˆæ¯')
        
        if not uid or not sendkey:
            print("âŒ é”™è¯¯ï¼šæœªé…ç½® Serveré…± UID æˆ– SendKey")
            exit(1)
        
        url = f"https://{uid}.push.ft07.com/send/{sendkey}.send"
        
        data = {
            "title": "ğŸ§ª UESTC-Energyfy æ¨é€æµ‹è¯•",
            "desp": f"""## ğŸ“± æµ‹è¯•æ¶ˆæ¯
        
        {message}
        
        ---
        
        âœ… å¦‚æœä½ æ”¶åˆ°äº†è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜ Serveré…± æ¨é€é…ç½®æ­£ç¡®ï¼
        
        ğŸ“Š **æµ‹è¯•ä¿¡æ¯**ï¼š
        - æµ‹è¯•æ—¶é—´ï¼š{os.popen('date "+%Y-%m-%d %H:%M:%S"').read().strip()}
        - è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘
        - Workflowï¼šTest Notification
        
        ğŸ’¡ **ä¸‹ä¸€æ­¥**ï¼š
        - å½“å®¿èˆç”µè´¹ä½™é¢ä½äºé˜ˆå€¼æ—¶ï¼Œä½ ä¼šè‡ªåŠ¨æ”¶åˆ°ç±»ä¼¼çš„æ¨é€é€šçŸ¥
        - å¯ä»¥åœ¨ GitHub Actions ä¸­æŸ¥çœ‹è¿è¡Œæ—¥å¿—
        """,
            "short": "æµ‹è¯•æ¨é€æˆåŠŸï¼å¦‚æœä½ çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜é…ç½®æ­£ç¡® âœ…"
        }
        
        print(f"ğŸš€ æ­£åœ¨å‘é€æµ‹è¯•æ¨é€åˆ° Serveré…±...")
        print(f"   UID: {uid}")
        print(f"   URL: {url}")
        
        try:
            response = requests.post(url, json=data, timeout=10)
            response.raise_for_status()
            result = response.json()
            
            print(f"\nâœ… æ¨é€å‘é€æˆåŠŸï¼")
            print(f"   å“åº”ä»£ç : {result.get('code')}")
            print(f"   å“åº”æ¶ˆæ¯: {result.get('message')}")
            print(f"\nğŸ“± è¯·æ£€æŸ¥ä½ çš„æ‰‹æœº Serveré…± APPï¼Œåº”è¯¥ä¼šæ”¶åˆ°æµ‹è¯•æ¶ˆæ¯ï¼")
            
            if result.get('code') != 0:
                print(f"\nâš ï¸  è­¦å‘Šï¼šæ¨é€å¯èƒ½å¤±è´¥")
                print(f"   è¯¦ç»†ä¿¡æ¯: {result}")
                exit(1)
                
        except requests.exceptions.RequestException as e:
            print(f"\nâŒ æ¨é€å‘é€å¤±è´¥: {e}")
            exit(1)
        except Exception as e:
            print(f"\nâŒ å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
            exit(1)
        EOF
    
    - name: ğŸ“§ æµ‹è¯•é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœé…ç½®ï¼‰
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_SECURITY: ${{ secrets.SMTP_SECURITY }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        TEST_MESSAGE: ${{ github.event.inputs.test_message }}
      run: |
        python - <<EOF
        import os
        import smtplib
        from email.mime.multipart import MIMEMultipart
        from email.mime.text import MIMEText
        from datetime import datetime
        
        smtp_server = os.environ.get('SMTP_SERVER')
        smtp_port = int(os.environ.get('SMTP_PORT', '465'))
        smtp_username = os.environ.get('SMTP_USERNAME')
        smtp_password = os.environ.get('SMTP_PASSWORD')
        smtp_security = os.environ.get('SMTP_SECURITY', 'ssl')
        recipients = os.environ.get('EMAIL_RECIPIENTS', '').split(',')
        message = os.environ.get('TEST_MESSAGE', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é‚®ä»¶')
        
        if not smtp_username or smtp_username == 'placeholder@example.com':
            print("â­ï¸  è·³è¿‡é‚®ä»¶æµ‹è¯•ï¼ˆæœªé…ç½®æœ‰æ•ˆçš„ SMTPï¼‰")
            exit(0)
        
        print(f"ğŸ“§ æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...")
        print(f"   SMTPæœåŠ¡å™¨: {smtp_server}:{smtp_port}")
        print(f"   å‘ä»¶äºº: {smtp_username}")
        print(f"   æ”¶ä»¶äºº: {recipients}")
        
        # åˆ›å»ºé‚®ä»¶
        msg = MIMEMultipart('alternative')
        msg['Subject'] = 'ğŸ§ª UESTC-Energyfy é‚®ä»¶æ¨é€æµ‹è¯•'
        msg['From'] = smtp_username
        msg['To'] = ', '.join(recipients)
        
        text_content = f"""
        UESTC-Energyfy é‚®ä»¶æ¨é€æµ‹è¯•
        
        {message}
        
        å¦‚æœä½ æ”¶åˆ°äº†è¿™å°é‚®ä»¶ï¼Œè¯´æ˜é‚®ä»¶æ¨é€é…ç½®æ­£ç¡®ï¼
        
        æµ‹è¯•æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        è§¦å‘æ–¹å¼: æ‰‹åŠ¨è§¦å‘
        Workflow: Test Notification
        """
        
        html_content = f"""
        <html>
        <body style="font-family: Arial, sans-serif; padding: 20px;">
            <h2 style="color: #4CAF50;">ğŸ§ª UESTC-Energyfy é‚®ä»¶æ¨é€æµ‹è¯•</h2>
            <p style="font-size: 16px;">{message}</p>
            <hr style="border: 1px solid #ddd;">
            <p style="color: #666;">
                âœ… å¦‚æœä½ æ”¶åˆ°äº†è¿™å°é‚®ä»¶ï¼Œè¯´æ˜é‚®ä»¶æ¨é€é…ç½®æ­£ç¡®ï¼<br><br>
                <strong>æµ‹è¯•ä¿¡æ¯ï¼š</strong><br>
                â€¢ æµ‹è¯•æ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}<br>
                â€¢ è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘<br>
                â€¢ Workflowï¼šTest Notification
            </p>
            <p style="color: #999; font-size: 12px;">
                ğŸ’¡ å½“å®¿èˆç”µè´¹ä½™é¢ä½äºé˜ˆå€¼æ—¶ï¼Œä½ ä¼šè‡ªåŠ¨æ”¶åˆ°ç±»ä¼¼çš„é‚®ä»¶é€šçŸ¥ã€‚
            </p>
        </body>
        </html>
        """
        
        msg.attach(MIMEText(text_content, 'plain', 'utf-8'))
        msg.attach(MIMEText(html_content, 'html', 'utf-8'))
        
        try:
            # è¿æ¥SMTPæœåŠ¡å™¨
            if smtp_security == 'ssl':
                server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=10)
            else:
                server = smtplib.SMTP(smtp_server, smtp_port, timeout=10)
                if smtp_security == 'tls':
                    server.starttls()
            
            # ç™»å½•å¹¶å‘é€
            server.login(smtp_username, smtp_password)
            server.sendmail(smtp_username, recipients, msg.as_string())
            server.quit()
            
            print(f"\nâœ… æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼")
            print(f"   è¯·æ£€æŸ¥æ”¶ä»¶ç®±ï¼ˆå¯èƒ½åœ¨åƒåœ¾é‚®ä»¶ä¸­ï¼‰")
            
        except Exception as e:
            print(f"\nâŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
            exit(1)
        EOF
    
    - name: âœ… æµ‹è¯•å®Œæˆ
      run: |
        echo "ğŸ‰ é€šçŸ¥æ¨é€æµ‹è¯•å®Œæˆï¼"
        echo ""
        echo "ğŸ“± è¯·æ£€æŸ¥ï¼š"
        echo "   - æ‰‹æœº Serveré…± APP æ˜¯å¦æ”¶åˆ°æ¨é€"
        echo "   - é‚®ç®±æ˜¯å¦æ”¶åˆ°æµ‹è¯•é‚®ä»¶ï¼ˆå¦‚æœé…ç½®äº†é‚®ä»¶ï¼‰"
        echo ""
        echo "ğŸ’¡ å¦‚æœæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œè¯´æ˜é…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼"
