name: UESTC Energy Monitor

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: âš™ï¸ ç”Ÿæˆé…ç½®æ–‡ä»¶
      env:
        # ä» GitHub Secrets è¯»å–é…ç½®
        UESTC_USERNAME: ${{ secrets.UESTC_USERNAME }}
        UESTC_PASSWORD: ${{ secrets.UESTC_PASSWORD }}
        ALERT_BALANCE: ${{ secrets.ALERT_BALANCE }}
        ROOM_NAME: ${{ secrets.ROOM_NAME }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_SECURITY: ${{ secrets.SMTP_SECURITY }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        SERVER_CHAN_ENABLED: ${{ secrets.SERVER_CHAN_ENABLED }}
        SERVER_CHAN_UID: ${{ secrets.SERVER_CHAN_UID }}
        SERVER_CHAN_SENDKEY: ${{ secrets.SERVER_CHAN_SENDKEY }}
      run: |
        python scripts/generate_config.py
    
    - name: ğŸ” æ‰§è¡Œç›‘æ§æ£€æŸ¥
      run: |
        python Energyfy.py -c config.json -l INFO --no-log-to-file
      continue-on-error: true
    
    - name: ğŸ“¤ ä¸Šä¼ æ—¥å¿—ï¼ˆå¦‚æœå¤±è´¥ï¼‰
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7
